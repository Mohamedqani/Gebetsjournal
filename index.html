<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mein Gebetsjournal mit Live-Gebetszeiten</title>
  <style>
    /* (Dein bisheriges CSS bleibt hier unverändert) */
    body { font-family: Arial, sans-serif; background: #f0f8ff; margin:0; padding:20px; }
    h1 { text-align:center; font-size:2rem; margin-bottom:20px; color:#333; }
    form { max-width:600px; margin:auto; background:#fff; padding:20px; border-radius:12px; box-shadow:0 0 10px rgba(0,0,0,0.1); }
    .prayer-section {...} /* wie gehabt */
    .prayer-header { font-size:1.2rem; font-weight:bold; margin-bottom:10px; }
    /* ... restliches CSS ... */
  </style>
  <!-- Adhan JS einbinden -->
  <script src="https://unpkg.com/adhan@4.4.3/dist/adhan.umd.js"></script>
</head>
<body>
  <h1>Mein Gebetsjournal mit Gebetszeiten</h1>

  <form id="prayerForm">
    <div class="prayer-section">
      <div class="prayer-header" id="fajr_header">🌅 Fajr</div>
      <label>Gebetet?<input type="checkbox" name="fajr_done" /></label>
      <textarea name="fajr_notes" placeholder="Notiz zum Fajr"></textarea>
    </div>
    <!-- Gleiches Prinzip für dhuhr, asr, maghrib, isha -->
    <div class="prayer-section">
      <div class="prayer-header" id="dhuhr_header">☀️ Dhuhr</div>
      <label>Gebetet?<input type="checkbox" name="dhuhr_done" /></label>
      <textarea name="dhuhr_notes" placeholder="Notiz zum Dhuhr"></textarea>
    </div>
    <div class="prayer-section">
      <div class="prayer-header" id="asr_header">🌇 Asr</div>
      <label>Gebetet?<input type="checkbox" name="asr_done" /></label>
      <textarea name="asr_notes" placeholder="Notiz zum Asr"></textarea>
    </div>
    <div class="prayer-section">
      <div class="prayer-header" id="maghrib_header">🌆 Maghrib</div>
      <label>Gebetet?<input type="checkbox" name="maghrib_done" /></label>
      <textarea name="maghrib_notes" placeholder="Notiz zum Maghrib"></textarea>
    </div>
    <div class="prayer-section">
      <div class="prayer-header" id="isha_header">🌙 Isha</div>
      <label>Gebetet?<input type="checkbox" name="isha_done" /></label>
      <textarea name="isha_notes" placeholder="Notiz zum Isha"></textarea>
    </div>
    <button type="submit">Speichern & Kalenderexport</button>
  </form>

  <script>
    const form = document.getElementById('prayerForm');
    const prayers = ['fajr','dhuhr','asr','maghrib','isha'];

    // Holt den Standort und berechnet Gebetszeiten
    function initPrayerTimes() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          const coords = new adhan.Coordinates(pos.coords.latitude, pos.coords.longitude);
          const params = adhan.CalculationMethod.MoonsightingCommittee(); // Standard
          const now = new Date();
          const times = new adhan.PrayerTimes(coords, now, params);

          const mapping = {
            fajr: times.fajr,
            dhuhr: times.dhuhr,
            asr: times.asr,
            maghrib: times.maghrib,
            isha: times.isha
          };

          Object.entries(mapping).forEach(([name, time]) => {
            const header = document.getElementById(`${name}_header`);
            if (header && time) {
              const h = time.getHours().toString().padStart(2,'0');
              const m = time.getMinutes().toString().padStart(2,'0');
              header.textContent = header.textContent + ` – ${h}:${m}`;
            }
          });
        }, err => {
          console.warn("Geolocation nicht aktiviert:", err);
        });
      } else {
        console.error("Geolocation wird nicht unterstützt.");
      }
    }

    // ICS-Logik und Reset wie gehabt
    function formatICSDate(date) {
      return date.toISOString().replace(/[-:]/g,'').split('.')[0]+'Z';
    }
    function createICSEvent(title,start,notes) {
      const end = new Date(start.getTime()+30*60000);
      return ['BEGIN:VEVENT','SUMMARY:'+title,'DTSTART:'+formatICSDate(start),
              'DTEND:'+formatICSDate(end),'DESCRIPTION:'+notes,'END:VEVENT'].join('\n');
    }

    form.addEventListener('submit', e => {
      e.preventDefault();
      const today = new Date();
      const prayerTimes = initDailyTimes(); // Dummy falls keine Adhan-Zeiten verfügbar

      let icsEvents = [];
      prayers.forEach(name => {
        const cb = form.querySelector(`[name=${name}_done]`);
        const notes = form.querySelector(`[name=${name}_notes]`).value;
        if (cb.checked) {
          const label = name.charAt(0).toUpperCase()+name.slice(1);
          const d = prayerTimes[name] || new Date(today);
          icsEvents.push(createICSEvent(`${label} Gebet`, d, notes));
        }
      });

      if (!icsEvents.length) {
        alert("Bitte mindestens ein Gebet auswählen.");
        return;
      }
      const ics = ['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//MeinGebetsjournal//DE', ...icsEvents,'END:VCALENDAR'].join('\n');
      const blob = new Blob([ics], {type:'text/calendar'});
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download='gebetsjournal.ics';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(link.href);
      alert("Kalender-Datei wurde heruntergeladen.");

      prayers.forEach(name => {
        form.querySelector(`[name=${name}_done]`).checked = false;
        form.querySelector(`[name=${name}_notes]`).value = '';
      });
    });

    // Wenn Adhan läuft, initPrayerTimes rufen
    initPrayerTimes();

    // Fallback ohne Adhan für ICS: Dummy-Uhrzeiten
    function initDailyTimes() {
      const today = new Date();
      return {
        fajr:    new Date(today.getFullYear(),today.getMonth(),today.getDate(),5,0),
        dhuhr:   new Date(today.getFullYear(),today.getMonth(),today.getDate(),12,30),
        asr:     new Date(today.getFullYear(),today.getMonth(),today.getDate(),15,30),
        maghrib: new Date(today.getFullYear(),today.getMonth(),today.getDate(),18,45),
        isha:    new Date(today.getFullYear(),today.getMonth(),today.getDate(),20,0),
      };
    }
  </script>
</body>
</html>
